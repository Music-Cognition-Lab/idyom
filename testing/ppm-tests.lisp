(cl:in-package #:ppm)

(5am:def-suite ppm :in testing::idyom-tests)
(5am:in-suite ppm)

(defun test-ppm (sequence &key (exclusion t) (escape :c) (mixtures t) (update-exclusion nil) (order-bound nil) ps write)
  (let* ((alphabet (sort (remove-duplicates sequence) #'string<=))
         (model (ppm:make-ppm alphabet :exclusion exclusion :escape escape :mixtures mixtures
                              :update-exclusion update-exclusion :order-bound order-bound))
         (result (ppm:model-dataset model (list sequence) :construct? t :predict? t)))
    (prog1 result
      (when write (write result :right-margin 110))
      (when ps (ppm:write-model-to-postscript model ps)))))

(defun test-ppm-dataset (sequences alphabet &key (exclusion t) (escape :c) (mixtures t) (update-exclusion nil) (order-bound nil) ps write)
  (let* ((model (ppm:make-ppm alphabet :exclusion exclusion :escape escape :mixtures mixtures
                              :update-exclusion update-exclusion :order-bound order-bound))
         (result (ppm:model-dataset model sequences :construct? t :predict? t)))
    (prog1 result
      (when write (write result :right-margin 110))
      (when ps (ppm:write-model-to-postscript model ps)))))

;; dataset tests
;; ===========================================================================

(5am:def-suite ppm*-dataset :in ppm)
(5am:in-suite ppm*-dataset)

(5am:test ppm*-dataset1
  (5am:is (equal (test-ppm-dataset '((a b r a c a d a b r a)
                                     (a b r a c a d a b r a))
                                   '(a b c d r))
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.59999996) (B 0.09999999) (C 0.09999999) (D 0.09999999) (R 0.09999999)))
                    (R ((A 0.33333334) (B 0.33333334) (C 0.11111111) (D 0.11111111) (R 0.11111111)))
                    (A ((A 0.25) (B 0.25) (C 0.125) (D 0.125) (R 0.25)))
                    (C ((A 0.20000002) (B 0.53333336) (C 0.06666668) (D 0.06666668) (R 0.13333336)))
                    (A ((A 0.26666665) (B 0.19999997) (C 0.19999997) (D 0.13333331) (R 0.19999997)))
                    (D ((A 0.20833334) (B 0.2916667) (C 0.2916667) (D 0.083333336) (R 0.125)))
                    (A ((A 0.25) (B 0.1875) (C 0.1875) (D 0.1875) (R 0.1875)))
                    (B ((A 0.2093023) (B 0.21705426) (C 0.21705426) (D 0.21705426) (R 0.13953489)))
                    (R ((A 0.19148937) (B 0.14893615) (C 0.12765956) (D 0.12765956) (R 0.40425533)))
                    (A ((A 0.4347826) (B 0.1521739) (C 0.13043477) (D 0.13043477) (R 0.1521739))))
                   (1 (A ((A 0.2777778) (B 0.19444445) (C 0.16666667) (D 0.16666667) (R 0.19444445)))
                    (B ((A 0.20245397) (B 0.28834355) (C 0.19018403) (D 0.19018403) (R 0.12883434)))
                    (R ((A 0.15714285) (B 0.11428571) (C 0.08571428) (D 0.08571428) (R 0.55714285)))
                    (A ((A 0.5692308) (B 0.12307692) (C 0.09230768) (D 0.09230768) (R 0.12307692)))
                    (C ((A 0.11999999) (B 0.23) (C 0.46) (D 0.10999999) (R 0.07999999)))
                    (A ((A 0.47272727) (B 0.14545456) (C 0.12727273) (D 0.10909091) (R 0.14545456)))
                    (D ((A 0.111428574) (B 0.20571429) (C 0.15142857) (D 0.46285713) (R 0.068571426)))
                    (A ((A 0.48275864) (B 0.13793103) (C 0.12068966) (D 0.12068966) (R 0.13793103)))
                    (B ((A 0.11351351) (B 0.5243243) (C 0.14864865) (D 0.14864865) (R 0.06486486)))
                    (R ((A 0.12612611) (B 0.08108108) (C 0.06306306) (D 0.06306306) (R 0.6666666)))
                    (A ((A 0.6701031) (B 0.09278351) (C 0.072164945) (D 0.072164945) (R 0.09278351))))))))

(5am:test ppm*-dataset2
  (5am:is (equal (test-ppm-dataset '((a b r a c a d a b r a)
                                     (l e t l e t t e r t e l e)
                                     (a s s a n i s s i m a s s a)
                                     (m i s s i s s i p p i)
                                     (w o o l o o b o o l o o))
                                   '(a b c d e i l m n o p r s t w))
                 '((0
                    (A
                     ((A 0.06666667) (B 0.06666667) (C 0.06666667) (D 0.06666667) (E 0.06666667) (I 0.06666667) (L 0.06666667)
                      (M 0.06666667) (N 0.06666667) (O 0.06666667) (P 0.06666667) (R 0.06666667) (S 0.06666667) (T 0.06666667)
                      (W 0.06666667)))
                    (B
                     ((A 0.5333332) (B 0.033333324) (C 0.033333324) (D 0.033333324) (E 0.033333324) (I 0.033333324)
                      (L 0.033333324) (M 0.033333324) (N 0.033333324) (O 0.033333324) (P 0.033333324) (R 0.033333324)
                      (S 0.033333324) (T 0.033333324) (W 0.033333324)))
                    (R
                     ((A 0.2758621) (B 0.2758621) (C 0.034482762) (D 0.034482762) (E 0.034482762) (I 0.034482762)
                      (L 0.034482762) (M 0.034482762) (N 0.034482762) (O 0.034482762) (P 0.034482762) (R 0.034482762)
                      (S 0.034482762) (T 0.034482762) (W 0.034482762)))
                    (A
                     ((A 0.19047616) (B 0.19047616) (C 0.03571428) (D 0.03571428) (E 0.03571428) (I 0.03571428) (L 0.03571428)
                      (M 0.03571428) (N 0.03571428) (O 0.03571428) (P 0.03571428) (R 0.19047616) (S 0.03571428) (T 0.03571428)
                      (W 0.03571428)))
                    (C
                     ((A 0.16571428) (B 0.5371428) (C 0.017142856) (D 0.017142856) (E 0.017142856) (I 0.017142856)
                      (L 0.017142856) (M 0.017142856) (N 0.017142856) (O 0.017142856) (P 0.017142856) (R 0.09142857)
                      (S 0.017142856) (T 0.017142856) (W 0.017142856)))
                    (A
                     ((A 0.2333334) (B 0.13333336) (C 0.13333336) (D 0.03333334) (E 0.03333334) (I 0.03333334) (L 0.03333334)
                      (M 0.03333334) (N 0.03333334) (O 0.03333334) (P 0.03333334) (R 0.13333336) (S 0.03333334) (T 0.03333334)
                      (W 0.03333334)))
                    (D
                     ((A 0.17543857) (B 0.28070173) (C 0.28070173) (D 0.017543858) (E 0.017543858) (I 0.017543858)
                      (L 0.017543858) (M 0.017543858) (N 0.017543858) (O 0.017543858) (P 0.017543858) (R 0.07017543)
                      (S 0.017543858) (T 0.017543858) (W 0.017543858)))
                    (A
                     ((A 0.24999997) (B 0.10526315) (C 0.10526315) (D 0.10526315) (E 0.032894734) (I 0.032894734)
                      (L 0.032894734) (M 0.032894734) (N 0.032894734) (O 0.032894734) (P 0.032894734) (R 0.10526315)
                      (S 0.032894734) (T 0.032894734) (W 0.032894734)))
                    (B
                     ((A 0.1794872) (B 0.19291821) (C 0.19291821) (D 0.19291821) (E 0.018315021) (I 0.018315021)
                      (L 0.018315021) (M 0.018315021) (N 0.018315021) (O 0.018315021) (P 0.018315021) (R 0.058608066)
                      (S 0.018315021) (T 0.018315021) (W 0.018315021)))
                    (R
                     ((A 0.15457413) (B 0.0851735) (C 0.050473183) (D 0.050473183) (E 0.01577287) (I 0.01577287) (L 0.01577287)
                      (M 0.01577287) (N 0.01577287) (O 0.01577287) (P 0.01577287) (R 0.50157726) (S 0.01577287) (T 0.01577287)
                      (W 0.01577287)))
                    (A
                     ((A 0.55555564) (B 0.08823531) (C 0.052287593) (D 0.052287593) (E 0.016339872) (I 0.016339872)
                      (L 0.016339872) (M 0.016339872) (N 0.016339872) (O 0.016339872) (P 0.016339872) (R 0.08823531)
                      (S 0.016339872) (T 0.016339872) (W 0.016339872))))
                   (1
                    (L
                     ((A 0.30612248) (B 0.13775513) (C 0.08163267) (D 0.08163267) (E 0.025510209) (I 0.025510209)
                      (L 0.025510209) (M 0.025510209) (N 0.025510209) (O 0.025510209) (P 0.025510209) (R 0.13775513)
                      (S 0.025510209) (T 0.025510209) (W 0.025510209)))
                    (E
                     ((A 0.26666674) (B 0.12380955) (C 0.076190494) (D 0.076190494) (E 0.028571432) (I 0.028571432)
                      (L 0.076190494) (M 0.028571432) (N 0.028571432) (O 0.028571432) (P 0.028571432) (R 0.12380955)
                      (S 0.028571432) (T 0.028571432) (W 0.028571432)))
                    (T
                     ((A 0.23423424) (B 0.11261262) (C 0.072072074) (D 0.072072074) (E 0.072072074) (I 0.03153153)
                      (L 0.072072074) (M 0.03153153) (N 0.03153153) (O 0.03153153) (P 0.03153153) (R 0.11261262) (S 0.03153153)
                      (T 0.03153153) (W 0.03153153)))
                    (L
                     ((A 0.20689656) (B 0.10344828) (C 0.06896552) (D 0.06896552) (E 0.06896552) (I 0.03448276) (L 0.06896552)
                      (M 0.03448276) (N 0.03448276) (O 0.03448276) (P 0.03448276) (R 0.10344828) (S 0.03448276) (T 0.06896552)
                      (W 0.03448276)))
                    (E
                     ((A 0.11538464) (B 0.05769232) (C 0.038461544) (D 0.038461544) (E 0.4615385) (I 0.019230772)
                      (L 0.05769232) (M 0.019230772) (N 0.019230772) (O 0.019230772) (P 0.019230772) (R 0.05769232)
                      (S 0.019230772) (T 0.038461544) (W 0.019230772)))
                    (T
                     ((A 0.11111112) (B 0.05555556) (C 0.03703704) (D 0.03703704) (E 0.05555556) (I 0.018518519) (L 0.05555556)
                      (M 0.018518519) (N 0.018518519) (O 0.018518519) (P 0.018518519) (R 0.05555556) (S 0.018518519)
                      (T 0.462963) (W 0.018518519)))
                    (T
                     ((A 0.10909091) (B 0.054545455) (C 0.03636364) (D 0.03636364) (E 0.054545455) (I 0.018181818)
                      (L 0.47272727) (M 0.018181818) (N 0.018181818) (O 0.018181818) (P 0.018181818) (R 0.054545455)
                      (S 0.018181818) (T 0.054545455) (W 0.018181818)))
                    (E
                     ((A 0.11111111) (B 0.055555556) (C 0.037037037) (D 0.037037037) (E 0.055555556) (I 0.018518517)
                      (L 0.24999999) (M 0.018518517) (N 0.018518517) (O 0.018518517) (P 0.018518517) (R 0.055555556)
                      (S 0.018518517) (T 0.2685185) (W 0.018518517)))
                    (R
                     ((A 0.07317073) (B 0.036585364) (C 0.024390245) (D 0.024390245) (E 0.04878049) (I 0.0121951215)
                      (L 0.036585364) (M 0.0121951215) (N 0.0121951215) (O 0.0121951215) (P 0.0121951215) (R 0.036585364)
                      (S 0.0121951215) (T 0.63414645) (W 0.0121951215)))
                    (T
                     ((A 0.64197534) (B 0.037037037) (C 0.024691358) (D 0.024691358) (E 0.04938272) (I 0.012345678)
                      (L 0.037037037) (M 0.012345678) (N 0.012345678) (O 0.012345678) (P 0.012345678) (R 0.04938272)
                      (S 0.012345678) (T 0.04938272) (W 0.012345678)))
                    (E
                     ((A 0.107142866) (B 0.053571433) (C 0.035714287) (D 0.035714287) (E 0.19047621) (I 0.017857142)
                      (L 0.17261906) (M 0.017857142) (N 0.017857142) (O 0.017857142) (P 0.017857142) (R 0.071428575)
                      (S 0.017857142) (T 0.20833336) (W 0.017857142)))
                    (L
                     ((A 0.051063832) (B 0.025531916) (C 0.017021278) (D 0.017021278) (E 0.042553194) (I 0.008510638)
                      (L 0.025531916) (M 0.008510638) (N 0.008510638) (O 0.008510638) (P 0.008510638) (R 0.5234043)
                      (S 0.008510638) (T 0.23829788) (W 0.008510638)))
                    (E
                     ((A 0.065217406) (B 0.0326087) (C 0.021739133) (D 0.021739133) (E 0.64130443) (I 0.010869566)
                      (L 0.043478265) (M 0.010869566) (N 0.010869566) (O 0.010869566) (P 0.010869566) (R 0.043478265)
                      (S 0.010869566) (T 0.05434783) (W 0.010869566))))
                   (2
                    (A
                     ((A 0.15384616) (B 0.07692308) (C 0.051282052) (D 0.051282052) (E 0.15384616) (I 0.025641026)
                      (L 0.102564104) (M 0.025641026) (N 0.025641026) (O 0.025641026) (P 0.025641026) (R 0.102564104)
                      (S 0.025641026) (T 0.12820514) (W 0.025641026)))
                    (S
                     ((A 0.08898303) (B 0.28389826) (C 0.14830507) (D 0.14830507) (E 0.07627117) (I 0.012711862) (L 0.05084745)
                      (M 0.012711862) (N 0.012711862) (O 0.012711862) (P 0.012711862) (R 0.05084745) (S 0.012711862)
                      (T 0.06355931) (W 0.012711862)))
                    (S
                     ((A 0.16088328) (B 0.07255521) (C 0.05047319) (D 0.05047319) (E 0.13880126) (I 0.028391166) (L 0.09463722)
                      (M 0.028391166) (N 0.028391166) (O 0.028391166) (P 0.028391166) (R 0.09463722) (S 0.05047319)
                      (T 0.11671924) (W 0.028391166)))
                    (A
                     ((A 0.09074731) (B 0.04092526) (C 0.028469749) (D 0.028469749) (E 0.07829181) (I 0.016014235)
                      (L 0.053380772) (M 0.016014235) (N 0.016014235) (O 0.016014235) (P 0.016014235) (R 0.053380772)
                      (S 0.46441275) (T 0.06583629) (W 0.016014235)))
                    (N
                     ((A 0.09630553) (B 0.2183479) (C 0.11664593) (D 0.11664593) (E 0.07305937) (I 0.014943962) (L 0.049813204)
                      (M 0.014943962) (N 0.014943962) (O 0.014943962) (P 0.014943962) (R 0.049813204) (S 0.12826902)
                      (T 0.061436288) (W 0.014943962)))
                    (I
                     ((A 0.16049382) (B 0.06790123) (C 0.049382713) (D 0.049382713) (E 0.12345679) (I 0.030864196)
                      (L 0.086419754) (M 0.030864196) (N 0.049382713) (O 0.030864196) (P 0.030864196) (R 0.086419754)
                      (S 0.06790123) (T 0.10493826) (W 0.030864196)))
                    (S
                     ((A 0.14603177) (B 0.06666668) (C 0.05079366) (D 0.05079366) (E 0.11428572) (I 0.05079366) (L 0.08253969)
                      (M 0.034920637) (N 0.05079366) (O 0.034920637) (P 0.034920637) (R 0.08253969) (S 0.06666668)
                      (T 0.098412715) (W 0.034920637)))
                    (S
                     ((A 0.26250002) (B 0.04375) (C 0.033333335) (D 0.033333335) (E 0.075) (I 0.033333335) (L 0.05416667)
                      (M 0.022916667) (N 0.033333335) (O 0.022916667) (P 0.022916667) (R 0.05416667) (S 0.22083335)
                      (T 0.06458333) (W 0.022916667)))
                    (I
                     ((A 0.5039549) (B 0.023728818) (C 0.0180791) (D 0.0180791) (E 0.040677976) (I 0.0180791) (L 0.02937854)
                      (M 0.012429382) (N 0.0180791) (O 0.012429382) (P 0.012429382) (R 0.02937854) (S 0.21581927)
                      (T 0.035028256) (W 0.012429382)))
                    (M
                     ((A 0.08679245) (B 0.039622642) (C 0.03018868) (D 0.03018868) (E 0.06792453) (I 0.039622642)
                      (L 0.049056605) (M 0.020754715) (N 0.03018868) (O 0.020754715) (P 0.020754715) (R 0.049056605)
                      (S 0.43584904) (T 0.058490567) (W 0.020754715)))
                    (A
                     ((A 0.1265823) (B 0.06329115) (C 0.05063292) (D 0.05063292) (E 0.10126584) (I 0.06329115) (L 0.07594938)
                      (M 0.05063292) (N 0.05063292) (O 0.03797469) (P 0.03797469) (R 0.07594938) (S 0.0886076) (T 0.0886076)
                      (W 0.03797469)))
                    (S
                     ((A 0.087579615) (B 0.16082802) (C 0.09235668) (D 0.09235668) (E 0.06369427) (I 0.039808914)
                      (L 0.047770698) (M 0.031847134) (N 0.09235668) (O 0.023885349) (P 0.023885349) (R 0.047770698)
                      (S 0.116242036) (T 0.055732477) (W 0.023885349)))
                    (S
                     ((A 0.12222222) (B 0.027777776) (C 0.02222222) (D 0.02222222) (E 0.04444444) (I 0.08888888) (L 0.03333333)
                      (M 0.02222222) (N 0.02222222) (O 0.016666666) (P 0.016666666) (R 0.03333333) (S 0.47222215)
                      (T 0.03888889) (W 0.016666666)))
                    (A
                     ((A 0.50993377) (B 0.01655629) (C 0.013245033) (D 0.013245033) (E 0.026490066) (I 0.16225165)
                      (L 0.019867549) (M 0.013245033) (N 0.013245033) (O 0.009933774) (P 0.009933774) (R 0.019867549)
                      (S 0.13907285) (T 0.023178808) (W 0.009933774))))
                   (3
                    (M
                     ((A 0.14457834) (B 0.060240973) (C 0.048192777) (D 0.048192777) (E 0.09638555) (I 0.060240973)
                      (L 0.07228917) (M 0.048192777) (N 0.048192777) (O 0.036144584) (P 0.036144584) (R 0.07228917)
                      (S 0.10843375) (T 0.08433736) (W 0.036144584)))
                    (I
                     ((A 0.42857146) (B 0.039682545) (C 0.031746034) (D 0.031746034) (E 0.063492075) (I 0.039682545)
                      (L 0.047619052) (M 0.039682545) (N 0.031746034) (O 0.023809526) (P 0.023809526) (R 0.047619052)
                      (S 0.07142858) (T 0.055555563) (W 0.023809526)))
                    (S
                     ((A 0.09302326) (B 0.03875969) (C 0.031007752) (D 0.031007752) (E 0.062015507) (I 0.046511628)
                      (L 0.046511628) (M 0.20930234) (N 0.031007752) (O 0.023255814) (P 0.023255814) (R 0.046511628)
                      (S 0.24031009) (T 0.054263566) (W 0.023255814)))
                    (S
                     ((A 0.15615615) (B 0.022522518) (C 0.018018015) (D 0.018018015) (E 0.036036033) (I 0.07807806)
                      (L 0.027027022) (M 0.022522518) (N 0.018018015) (O 0.013513511) (P 0.013513511) (R 0.027027022)
                      (S 0.50450444) (T 0.031531528) (W 0.013513511)))
                    (I
                     ((A 0.25675678) (B 0.011261261) (C 0.009009008) (D 0.009009008) (E 0.018018018) (I 0.48573574)
                      (L 0.013513514) (M 0.011261261) (N 0.009009008) (O 0.006756756) (P 0.006756756) (R 0.013513514)
                      (S 0.12687689) (T 0.015765766) (W 0.006756756)))
                    (S
                     ((A 0.048879836) (B 0.020366598) (C 0.016293278) (D 0.016293278) (E 0.03258656) (I 0.028513238)
                      (L 0.024439918) (M 0.47861508) (N 0.016293278) (O 0.012219959) (P 0.012219959) (R 0.024439918)
                      (S 0.2281059) (T 0.028513238) (W 0.012219959)))
                    (S
                     ((A 0.10246305) (B 0.0147783235) (C 0.011822659) (D 0.011822659) (E 0.023645317) (I 0.08768473)
                      (L 0.017733987) (M 0.0147783235) (N 0.011822659) (O 0.008866994) (P 0.008866994) (R 0.017733987)
                      (S 0.6384236) (T 0.020689653) (W 0.008866994)))
                    (I
                     ((A 0.17028984) (B 0.006793478) (C 0.005434782) (D 0.005434782) (E 0.0108695645) (I 0.65625006)
                      (L 0.008152174) (M 0.006793478) (N 0.005434782) (O 0.0040760865) (P 0.0040760865) (R 0.008152174)
                      (S 0.0946558) (T 0.009510869) (W 0.0040760865)))
                    (P
                     ((A 0.08759124) (B 0.03649635) (C 0.02919708) (D 0.02919708) (E 0.05839416) (I 0.05839416) (L 0.04379562)
                      (M 0.20437954) (N 0.02919708) (O 0.02189781) (P 0.02189781) (R 0.04379562) (S 0.2627737) (T 0.051094886)
                      (W 0.02189781)))
                    (P
                     ((A 0.11904763) (B 0.05654762) (C 0.04761905) (D 0.04761905) (E 0.083333336) (I 0.083333336)
                      (L 0.065476194) (M 0.05654762) (N 0.04761905) (O 0.038690478) (P 0.04761905) (R 0.065476194)
                      (S 0.1279762) (T 0.07440477) (W 0.038690478)))
                    (I
                     ((A 0.07751938) (B 0.036821708) (C 0.031007754) (D 0.031007754) (E 0.054263566) (I 0.054263566)
                      (L 0.042635657) (M 0.036821708) (N 0.031007754) (O 0.0251938) (P 0.37984493) (R 0.042635657)
                      (S 0.08333333) (T 0.048449613) (W 0.0251938))))
                   (4
                    (W
                     ((A 0.11695906) (B 0.055555545) (C 0.04678362) (D 0.04678362) (E 0.08187134) (I 0.090643264)
                      (L 0.06432748) (M 0.055555545) (N 0.04678362) (O 0.03801169) (P 0.055555545) (R 0.06432748)
                      (S 0.12573099) (T 0.073099405) (W 0.03801169)))
                    (O
                     ((A 0.103225805) (B 0.058064517) (C 0.051612902) (D 0.051612902) (E 0.077419356) (I 0.08387097)
                      (L 0.06451613) (M 0.058064517) (N 0.051612902) (O 0.04516129) (P 0.058064517) (R 0.06451613)
                      (S 0.10967742) (T 0.07096774) (W 0.051612902)))
                    (O
                     ((A 0.08695652) (B 0.061594207) (C 0.057971016) (D 0.057971016) (E 0.072463766) (I 0.07608696)
                      (L 0.06521739) (M 0.061594207) (N 0.057971016) (O 0.057971016) (P 0.061594207) (R 0.06521739)
                      (S 0.09057971) (T 0.06884058) (W 0.057971016)))
                    (L
                     ((A 0.070175424) (B 0.04970759) (C 0.04678362) (D 0.04678362) (E 0.05847952) (I 0.061403498)
                      (L 0.05263157) (M 0.04970759) (N 0.04678362) (O 0.23976606) (P 0.04970759) (R 0.05263157) (S 0.073099405)
                      (T 0.055555545) (W 0.04678362)))
                    (O
                     ((A 0.051391866) (B 0.036402572) (C 0.034261245) (D 0.034261245) (E 0.4475375) (I 0.044967882)
                      (L 0.040685225) (M 0.036402572) (N 0.034261245) (O 0.036402572) (P 0.036402572) (R 0.0385439)
                      (S 0.053533193) (T 0.040685225) (W 0.034261245)))
                    (O
                     ((A 0.070381224) (B 0.049853366) (C 0.046920814) (D 0.046920814) (E 0.058651015) (I 0.06158357)
                      (L 0.14662755) (M 0.049853366) (N 0.046920814) (O 0.143695) (P 0.049853366) (R 0.05278592) (S 0.07331377)
                      (T 0.05571847) (W 0.046920814)))
                    (B
                     ((A 0.04828973) (B 0.034205224) (C 0.03219315) (D 0.03219315) (E 0.04024144) (I 0.042253513)
                      (L 0.35010055) (M 0.034205224) (N 0.03219315) (O 0.16297783) (P 0.034205224) (R 0.0362173) (S 0.0503018)
                      (T 0.03822937) (W 0.03219315)))
                    (O
                     ((A 0.05755395) (B 0.04316546) (C 0.038369298) (D 0.038369298) (E 0.047961622) (I 0.050359704)
                      (L 0.04556354) (M 0.04076738) (N 0.038369298) (O 0.04556354) (P 0.04076738) (R 0.36930457) (S 0.05995203)
                      (T 0.04556354) (W 0.038369298)))
                    (O
                     ((A 0.066298336) (B 0.10497238) (C 0.044198893) (D 0.044198893) (E 0.055248614) (I 0.058011044)
                      (L 0.10773481) (M 0.046961322) (N 0.044198893) (O 0.16574587) (P 0.046961322) (R 0.04972375)
                      (S 0.069060765) (T 0.052486185) (W 0.044198893)))
                    (L
                     ((A 0.04771372) (B 0.19483101) (C 0.031809147) (D 0.031809147) (E 0.03976143) (I 0.041749507)
                      (L 0.1968191) (M 0.033797216) (N 0.031809147) (O 0.1610338) (P 0.033797216) (R 0.03578529) (S 0.04970179)
                      (T 0.03777336) (W 0.031809147)))
                    (O
                     ((A 0.042290747) (B 0.03171806) (C 0.02819383) (D 0.02819383) (E 0.20176212) (I 0.037004404)
                      (L 0.03524229) (M 0.029955944) (N 0.02819383) (O 0.37004408) (P 0.029955944) (R 0.03171806)
                      (S 0.04405286) (T 0.033480175) (W 0.02819383)))
                    (O
                     ((A 0.045714285) (B 0.07238095) (C 0.030476192) (D 0.030476192) (E 0.03809524) (I 0.040000003)
                      (L 0.114285715) (M 0.032380953) (N 0.030476192) (O 0.38476193) (P 0.032380953) (R 0.034285717)
                      (S 0.04761905) (T 0.036190476) (W 0.030476192))))))))
          


;; Simple Tests
;; ===========================================================================

(5am:def-suite ppm*-simple :in ppm)
(5am:in-suite ppm*-simple)

(5am:test kkkkkkkkk-ppmc*
  (5am:is (equal (test-ppm '(k k k k k k k k k) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0)))
                    (K ((K 1.0))))))))

(5am:test aaaaaaaabb-ppmc*
  (5am:is (equal (test-ppm '(a a a a a a a a b b) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.5) (B 0.5)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (A ((A 0.6666667) (B 0.33333334)))
                    (B ((A 0.6666667) (B 0.33333334)))
                    (B ((A 0.88888884) (B 0.111111104))))))))
                 
(5am:test ababc-ppmc*
  (5am:is (equal (test-ppm '(a b a b c) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.33333334) (B 0.33333334) (C 0.33333334)))
                    (B ((A 0.59999996) (B 0.19999999) (C 0.19999999)))
                    (A ((A 0.33333334) (B 0.33333334) (C 0.33333334)))
                    (B ((A 0.2857143) (B 0.5714286) (C 0.14285715)))
                    (C ((A 0.5714286) (B 0.2857143) (C 0.14285715))))))))


;; PPM* without exclusion
;; ===========================================================================

(5am:def-suite ppm*-exclusion :in ppm)
(5am:in-suite ppm*-exclusion)

(5am:test abracadabra-ppmc*-without-exclusion
  (5am:is (equal (test-ppm '(a b r a c a d a b r a) :exclusion nil :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.2) (B 0.2) (C 0.2) (D 0.2) (R 0.2)))
                    (B ((A 0.5555555) (B 0.111111104) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (R ((A 0.31249997) (B 0.31249997) (C 0.12499999) (D 0.12499999) (R 0.12499999)))
                    (A ((A 0.23809522) (B 0.23809522) (C 0.14285713) (D 0.14285713) (R 0.23809522)))
                    (C ((A 0.17857143) (B 0.625) (C 0.053571425) (D 0.053571425) (R 0.08928572)))
                    (A ((A 0.3448276) (B 0.1724138) (C 0.1724138) (D 0.13793102) (R 0.1724138)))
                    (D ((A 0.20270272) (B 0.33783785) (C 0.33783785) (D 0.054054055) (R 0.06756757)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (B ((A 0.22222221) (B 0.24074072) (C 0.24074072) (D 0.24074072) (R 0.055555552)))
                    (R ((A 0.18181819) (B 0.09090909) (C 0.045454547) (D 0.045454547) (R 0.6363636)))
                    (A ((A 0.7142857) (B 0.0952381) (C 0.04761905) (D 0.04761905) (R 0.0952381))))))))


;; PPM* with Blending
;; ===========================================================================

(5am:def-suite ppm*-blending :in ppm)
(5am:in-suite ppm*-blending)

;; abracadabra (Cleary & Teahan, 1997; Bunton, 1996)
(5am:test abracadabra-ppmc*
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.5555555) (B 0.111111104) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (R ((A 0.2857143) (B 0.2857143) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (C ((A 0.18181819) (B 0.54545456) (C 0.09090909) (D 0.09090909) (R 0.09090909)))
                    (A ((A 0.2857143) (B 0.14285715) (C 0.14285715) (D 0.28571427) (R 0.14285715)))
                    (D ((A 0.21428573) (B 0.2857143) (C 0.2857143) (D 0.14285715) (R 0.071428575)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (B ((A 0.26666665) (B 0.22222221) (C 0.22222221) (D 0.22222221) (R 0.06666666)))
                    (R ((A 0.19047621) (B 0.095238104) (C 0.047619052) (D 0.047619052) (R 0.61904764)))
                    (A ((A 0.6470587) (B 0.117647044) (C 0.058823522) (D 0.058823522) (R 0.117647044)))
                    (C ((A 0.11627906) (B 0.18604651) (C 0.5581395) (D 0.093023255) (R 0.046511628))))))))

;; letlettertele (Larsson, 1999)
(5am:test letlettertele-ppmc*
  (5am:is (equal (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (L ((E 0.25) (L 0.25) (R 0.25) (T 0.25)))
                    (E ((E 0.14285715) (L 0.5714286) (R 0.14285715) (T 0.14285715)))
                    (T ((E 0.29999998) (L 0.29999998) (R 0.19999999) (T 0.19999999)))
                    (L ((E 0.22222221) (L 0.22222221) (R 0.3333333) (T 0.22222221)))
                    (E ((E 0.5714286) (L 0.19047621) (R 0.14285715) (T 0.095238104)))
                    (T ((E 0.16000001) (L 0.16000001) (R 0.11999999) (T 0.56)))
                    (T ((E 0.16000001) (L 0.56) (R 0.11999999) (T 0.16000001)))
                    (E ((E 0.2352941) (L 0.29411763) (R 0.17647058) (T 0.29411763)))
                    (R ((E 0.13333333) (L 0.08888889) (R 0.06666666) (T 0.7111112)))
                    (T ((E 0.33333334) (L 0.22222222) (R 0.11111111) (T 0.33333334)))
                    (E ((E 0.2777778) (L 0.2777778) (R 0.16666667) (T 0.2777778)))
                    (L ((E 0.11111113) (L 0.055555563) (R 0.5555556) (T 0.2777778)))
                    (E ((E 0.75) (L 0.09374999) (R 0.031249998) (T 0.12499999))))))))
                 
;; assanissimassa (Blelloch, 2001)
(5am:test assanissimassa-ppmc*
  (5am:is (equal (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.19999999) (I 0.19999999) (M 0.19999999) (N 0.19999999) (S 0.19999999)))
                    (S ((A 0.5555555) (I 0.111111104) (M 0.111111104) (N 0.111111104) (S 0.111111104)))
                    (S ((A 0.2857143) (I 0.14285715) (M 0.14285715) (N 0.14285715) (S 0.2857143)))
                    (A ((A 0.18181819) (I 0.090909086) (M 0.090909086) (N 0.090909086) (S 0.54545456)))
                    (N ((A 0.26666668) (I 0.06666667) (M 0.06666667) (N 0.06666667) (S 0.53333336)))
                    (I ((A 0.2857143) (I 0.14285715) (M 0.14285715) (N 0.14285715) (S 0.2857143)))
                    (S ((A 0.25) (I 0.125) (M 0.24999996) (N 0.125) (S 0.25)))
                    (S ((A 0.3) (I 0.10000001) (M 0.2) (N 0.10000001) (S 0.3)))
                    (I ((A 0.54545456) (I 0.045454547) (M 0.090909086) (N 0.045454547) (S 0.27272728)))
                    (M ((A 0.12500001) (I 0.12500001) (M 0.12499999) (N 0.06250001) (S 0.5625)))
                    (A ((A 0.20000002) (I 0.20000002) (M 0.10000001) (N 0.10000001) (S 0.40000004)))
                    (S ((A 0.1764706) (I 0.11764707) (M 0.058823533) (N 0.32352942) (S 0.32352942)))
                    (S ((A 0.12727273) (I 0.12727273) (M 0.05454546) (N 0.05454546) (S 0.6363636)))
                    (A ((A 0.5675675) (I 0.18918918) (M 0.027027026) (N 0.027027026) (S 0.18918917))))))))

;; mississippi (Witten et al., 1999)
(5am:test mississippi-ppmc*
  (5am:is (equal (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (M ((I 0.25) (M 0.25) (P 0.25) (S 0.25)))
                    (I ((I 0.14285715) (M 0.5714286) (P 0.14285715) (S 0.14285715)))
                    (S ((I 0.29999998) (M 0.29999998) (P 0.19999999) (S 0.19999999)))
                    (S ((I 0.22222221) (M 0.22222221) (P 0.3333333) (S 0.22222221)))
                    (I ((I 0.11764705) (M 0.11764705) (P 0.17647058) (S 0.58823526)))
                    (S ((I 0.19047621) (M 0.095238104) (P 0.14285715) (S 0.5714286)))
                    (S ((I 0.19047621) (M 0.0952381) (P 0.14285713) (S 0.5714286)))
                    (I ((I 0.55172414) (M 0.06896552) (P 0.10344827) (S 0.27586207)))
                    (P ((I 0.24000002) (M 0.080000006) (P 0.11999999) (S 0.56)))
                    (P ((I 0.33333334) (M 0.11111111) (P 0.11111111) (S 0.44444445)))
                    (I ((I 0.14999999) (M 0.049999997) (P 0.59999996) (S 0.19999999))))))))

;; woolloomooloo (Williams, 1991)
(5am:test woolloomooloo-ppmc*
  (5am:is (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (W ((L 0.25) (M 0.25) (O 0.25) (W 0.25)))
                    (O ((L 0.14285715) (M 0.14285715) (O 0.14285715) (W 0.5714286)))
                    (O ((L 0.19999999) (M 0.19999999) (O 0.29999998) (W 0.29999998)))
                    (L ((L 0.12499999) (M 0.12499999) (O 0.5625) (W 0.1875)))
                    (L ((L 0.18181819) (M 0.27272725) (O 0.36363637) (W 0.18181819)))
                    (O ((L 0.5714286) (M 0.14285715) (O 0.19047621) (W 0.095238104)))
                    (O ((L 0.30769232) (M 0.23076925) (O 0.30769232) (W 0.15384616)))
                    (M ((L 0.55172414) (M 0.10344827) (O 0.27586207) (W 0.06896552)))
                    (O ((L 0.25) (M 0.125) (O 0.5) (W 0.125)))
                    (O ((L 0.21739131) (M 0.21739131) (O 0.43478262) (W 0.13043478)))
                    (L ((L 0.3125) (M 0.3125) (O 0.3125) (W 0.0625)))
                    (O ((L 0.64285713) (M 0.07142857) (O 0.21428572) (W 0.07142857)))
                    (O ((L 0.20833334) (M 0.10416667) (O 0.625) (W 0.0625))))))))
                 
;; agcgacgag (Giegerich & Kurtz, 1994, 1995)
(5am:test agcgacgag-ppmc*
  (5am:is (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.33333334) (C 0.33333334) (G 0.33333334)))
                    (G ((A 0.59999996) (C 0.19999999) (G 0.19999999)))
                    (C ((A 0.33333334) (C 0.33333334) (G 0.33333334)))
                    (G ((A 0.33333334) (C 0.33333334) (G 0.33333334)))
                    (A ((A 0.11111112) (C 0.6666667) (G 0.22222224)))
                    (C ((A 0.22222224) (C 0.11111112) (G 0.6666667)))
                    (G ((A 0.18181819) (C 0.18181819) (G 0.6363636)))
                    (A ((A 0.59999996) (C 0.19999999) (G 0.19999997)))
                    (G ((A 0.2) (C 0.6) (G 0.20000002))))))))


;; PPM* with Blending and Update Exclusion
;; ===========================================================================

(5am:def-suite ppm-blending-update-exclusion :in ppm)
(5am:in-suite ppm-blending-update-exclusion)

;; abracadabra (Cleary & Teahan, 1997; Bunton, 1996)
(5am:test abracadabra-ppmc*u
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion t :order-bound nil)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.5555555) (B 0.111111104) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (R ((A 0.2857143) (B 0.2857143) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (C ((A 0.18181819) (B 0.54545456) (C 0.09090909) (D 0.09090909) (R 0.09090909)))
                    (A ((A 0.2857143) (B 0.14285715) (C 0.14285715) (D 0.28571427) (R 0.14285715)))
                    (D ((A 0.21428573) (B 0.2857143) (C 0.2857143) (D 0.14285715) (R 0.071428575)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (B ((A 0.26666665) (B 0.22222221) (C 0.22222221) (D 0.22222221) (R 0.06666666)))
                    (R ((A 0.21052633) (B 0.052631583) (C 0.052631583) (D 0.052631583) (R 0.631579)))
                    (A ((A 0.6923076) (B 0.076923065) (C 0.076923065) (D 0.076923065) (R 0.076923065)))
                    (C ((A 0.11428572) (B 0.19047621) (C 0.5714286) (D 0.095238104) (R 0.02857143))))))))


;; PPM with Blending and fixed order bound
;; ===========================================================================

(5am:def-suite ppm-blending-order-bound :in ppm)
(5am:in-suite ppm-blending-order-bound)

;; Abracadabra
(5am:test abracadabra-ppmc2
  (5am:is (and (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound 2)
                      (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound nil))
               (not (equal
                     (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)
                     (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound nil))))))
          

(5am:test abracadabra-ppmc1
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.5555555) (B 0.111111104) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (R ((A 0.2857143) (B 0.2857143) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (C ((A 0.18181819) (B 0.54545456) (C 0.09090909) (D 0.09090909) (R 0.09090909)))
                    (A ((A 0.2857143) (B 0.14285715) (C 0.14285715) (D 0.28571427) (R 0.14285715)))
                    (D ((A 0.21428573) (B 0.2857143) (C 0.2857143) (D 0.14285715) (R 0.071428575)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (B ((A 0.26666665) (B 0.22222221) (C 0.22222221) (D 0.22222221) (R 0.06666666)))
                    (R ((A 0.19047621) (B 0.095238104) (C 0.047619052) (D 0.047619052) (R 0.61904764)))
                    (A ((A 0.6470587) (B 0.117647044) (C 0.058823522) (D 0.058823522) (R 0.117647044)))
                    (C ((A 0.2173913) (B 0.34782612) (C 0.17391306) (D 0.17391306) (R 0.08695652))))))))

(5am:test abracadabra-ppmc0
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures nil :update-exclusion nil :order-bound 0)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.5555555) (B 0.111111104) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (R ((A 0.2857143) (B 0.2857143) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (C ((A 0.33333334) (B 0.16666667) (C 0.16666666) (D 0.16666666) (R 0.16666667)))
                    (A ((A 0.2857143) (B 0.14285715) (C 0.14285715) (D 0.28571427) (R 0.14285715)))
                    (D ((A 0.37499997) (B 0.125) (C 0.125) (D 0.24999996) (R 0.125)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (B ((A 0.49999997) (B 0.12499999) (C 0.12499999) (D 0.12499999) (R 0.12499999)))
                    (R ((A 0.44444442) (B 0.22222221) (C 0.111111104) (D 0.111111104) (R 0.111111104)))
                    (A ((A 0.40000004) (B 0.20000002) (C 0.10000001) (D 0.10000001) (R 0.20000002)))
                    (C ((A 0.45454547) (B 0.18181819) (C 0.09090909) (D 0.09090909) (R 0.18181819))))))))

;; letlettertele
(5am:test letlettertele-ppmc2
  (5am:is (equal (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures nil :update-exclusion nil :order-bound 2))))

(5am:test letlettertele-ppmc1
  (5am:is (not (equal
                (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)))))

;; assanissimassa
(5am:test assanissimassa-ppmc3
  (5am:is (equal (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures nil :update-exclusion nil :order-bound 3))))

(5am:test assanissimassa-ppmc2
  (5am:is (not (equal
                (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures nil :update-exclusion nil :order-bound 2)))))

;; missisippi
(5am:test mississippi-ppmc2
  (5am:is (equal (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures nil :update-exclusion nil :order-bound 2))))

(5am:test mississippi-ppmc1
  (5am:is (not (equal
                (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)))))

;; woolloomooloo
(5am:test woolloomooloo-ppmc2
  (5am:is (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound nil) 
                 (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound 2))))

(5am:test woolloomooloo-ppmc1
  (5am:is (not (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound nil) 
                      (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)))))

;; agcgacgag
(5am:test agcgacgag-ppmc2
  (5am:is (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 (test-ppm '(a g c g a c g a g) :escape :c :mixtures nil :update-exclusion nil :order-bound 2))))

(5am:test agcgacgag-ppmc1
  (5am:is (not (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                      (test-ppm '(a g c g a c g a g) :escape :c :mixtures nil :update-exclusion nil :order-bound 1)))))
          
                 
;; PPM* with Mixtures
;; ===========================================================================

(5am:def-suite ppm*-mixtures :in ppm)
(5am:in-suite ppm*-mixtures)

;; abracadabrac (Cleary & Teahan, 1997; Bunton, 1996)
(5am:test abracadabra-ppmc*i
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.59999996) (B 0.09999999) (C 0.09999999) (D 0.09999999) (R 0.09999999)))
                    (R ((A 0.33333334) (B 0.33333334) (C 0.11111111) (D 0.11111111) (R 0.11111111)))
                    (A ((A 0.25) (B 0.25) (C 0.125) (D 0.125) (R 0.25)))
                    (C ((A 0.20000002) (B 0.53333336) (C 0.06666668) (D 0.06666668) (R 0.13333336)))
                    (A ((A 0.26666665) (B 0.19999997) (C 0.19999997) (D 0.13333331) (R 0.19999997)))
                    (D ((A 0.20833334) (B 0.2916667) (C 0.2916667) (D 0.083333336) (R 0.125)))
                    (A ((A 0.25) (B 0.1875) (C 0.1875) (D 0.1875) (R 0.1875)))
                    (B ((A 0.2093023) (B 0.21705426) (C 0.21705426) (D 0.21705426) (R 0.13953489)))
                    (R ((A 0.19148937) (B 0.14893615) (C 0.12765956) (D 0.12765956) (R 0.40425533)))
                    (A ((A 0.4347826) (B 0.1521739) (C 0.13043477) (D 0.13043477) (R 0.1521739)))
                    (C ((A 0.13157894) (B 0.1973684) (C 0.44736835) (D 0.13157894) (R 0.092105255))))))))

;; letlettertele (Larsson, 1999)
(5am:test letlettertele-ppmc*i
  (5am:is (equal (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 '((0 (L ((E 0.25) (L 0.25) (R 0.25) (T 0.25)))
                    (E ((E 0.125) (L 0.625) (R 0.125) (T 0.125)))
                    (T ((E 0.35714287) (L 0.35714287) (R 0.14285715) (T 0.14285715)))
                    (L ((E 0.2777778) (L 0.2777778) (R 0.16666667) (T 0.2777778)))
                    (E ((E 0.53125) (L 0.21875001) (R 0.09375) (T 0.15625)))
                    (T ((E 0.19444443) (L 0.19444443) (R 0.08333332) (T 0.5277778)))
                    (T ((E 0.18421054) (L 0.5526316) (R 0.07894737) (T 0.18421054)))
                    (E ((E 0.19444445) (L 0.3333333) (R 0.08333333) (T 0.3888889)))
                    (R ((E 0.14999999) (L 0.11666667) (R 0.049999997) (T 0.68333334)))
                    (T ((E 0.28) (L 0.23999998) (R 0.19999999) (T 0.28)))
                    (E ((E 0.27956992) (L 0.24731185) (R 0.16129033) (T 0.311828)))
                    (L ((E 0.12903225) (L 0.0967742) (R 0.48387095) (T 0.29032257)))
                    (E ((E 0.6153847) (L 0.13461538) (R 0.09615384) (T 0.15384616))))))))
                 
;; assanissimassa (Blelloch, 2001)
(5am:test assanissimassa-ppmc*i
  (5am:is (equal (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.19999999) (I 0.19999999) (M 0.19999999) (N 0.19999999) (S 0.19999999)))
                    (S ((A 0.59999996) (I 0.09999999) (M 0.09999999) (N 0.09999999) (S 0.09999999)))
                    (S ((A 0.33333334) (I 0.11111111) (M 0.11111111) (N 0.11111111) (S 0.33333334)))
                    (A ((A 0.1764706) (I 0.058823526) (M 0.058823526) (N 0.058823526) (S 0.64705884)))
                    (N ((A 0.23809524) (I 0.04761905) (M 0.04761905) (N 0.04761905) (S 0.61904764)))
                    (I ((A 0.3) (I 0.1) (M 0.1) (N 0.2) (S 0.3)))
                    (S ((A 0.25) (I 0.1875) (M 0.12499999) (N 0.1875) (S 0.25)))
                    (S ((A 0.30434784) (I 0.13043478) (M 0.086956516) (N 0.13043478) (S 0.34782606)))
                    (I ((A 0.4871795) (I 0.07692308) (M 0.051282052) (N 0.07692308) (S 0.30769232)))
                    (M ((A 0.14285715) (I 0.14285715) (M 0.07142857) (N 0.10714285) (S 0.53571427)))
                    (A ((A 0.19999999) (I 0.19999999) (M 0.17142856) (N 0.17142856) (S 0.25714287)))
                    (S ((A 0.17021279) (I 0.14893618) (M 0.12765957) (N 0.24468085) (S 0.30851063)))
                    (S ((A 0.17816092) (I 0.16091955) (M 0.10344828) (N 0.10344828) (S 0.454023)))
                    (A ((A 0.4527559) (I 0.19291338) (M 0.07086614) (N 0.07086614) (S 0.21259843))))))))

;; mississippi (Witten et al., 1999)
(5am:test mississippi-ppmc*i
  (5am:is (equal (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 '((0 (M ((I 0.25) (M 0.25) (P 0.25) (S 0.25))) (I ((I 0.125) (M 0.625) (P 0.125) (S 0.125)))
                    (S ((I 0.35714287) (M 0.35714287) (P 0.14285715) (S 0.14285715)))
                    (S ((I 0.2777778) (M 0.2777778) (P 0.16666667) (S 0.2777778)))
                    (I ((I 0.16666667) (M 0.16666667) (P 0.10000001) (S 0.5666667)))
                    (S ((I 0.20588236) (M 0.14705881) (P 0.08823529) (S 0.5588235)))
                    (S ((I 0.25) (M 0.11363636) (P 0.06818181) (S 0.5681818)))
                    (I ((I 0.5) (M 0.0925926) (P 0.055555556) (S 0.35185185)))
                    (P ((I 0.21428573) (M 0.11904763) (P 0.07142857) (S 0.5952381)))
                    (P ((I 0.28000003) (M 0.2) (P 0.2) (S 0.32)))
                    (I ((I 0.18421052) (M 0.13157895) (P 0.47368425) (S 0.21052632))))))))
                 
;; woolloomooloo (Williams, 1991)
(5am:test woolloomooloo-ppmc*i
  (5am:is (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures nil :update-exclusion nil :order-bound nil)
                 '((0 (W ((L 0.25) (M 0.25) (O 0.25) (W 0.25)))
                    (O ((L 0.14285715) (M 0.14285715) (O 0.14285715) (W 0.5714286)))
                    (O ((L 0.19999999) (M 0.19999999) (O 0.29999998) (W 0.29999998)))
                    (L ((L 0.12499999) (M 0.12499999) (O 0.5625) (W 0.1875)))
                    (L ((L 0.18181819) (M 0.27272725) (O 0.36363637) (W 0.18181819)))
                    (O ((L 0.5714286) (M 0.14285715) (O 0.19047621) (W 0.095238104)))
                    (O ((L 0.30769232) (M 0.23076925) (O 0.30769232) (W 0.15384616)))
                    (M ((L 0.55172414) (M 0.10344827) (O 0.27586207) (W 0.06896552)))
                    (O ((L 0.25) (M 0.125) (O 0.5) (W 0.125)))
                    (O ((L 0.21739131) (M 0.21739131) (O 0.43478262) (W 0.13043478)))
                    (L ((L 0.3125) (M 0.3125) (O 0.3125) (W 0.0625)))
                    (O ((L 0.64285713) (M 0.07142857) (O 0.21428572) (W 0.07142857)))
                    (O ((L 0.20833334) (M 0.10416667) (O 0.625) (W 0.0625))))))))
                 
;; agcgacgag (Giegerich & Kurtz, 1994, 1995)
(5am:test agcgacgag-ppmc*i
  (5am:is (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 '((0 (A ((A 0.33333334) (C 0.33333334) (G 0.33333334)))
                    (G ((A 0.6666667) (C 0.16666667) (G 0.16666667)))
                    (C ((A 0.4) (C 0.2) (G 0.4)))
                    (G ((A 0.33333334) (C 0.33333334) (G 0.33333334)))
                    (A ((A 0.21052633) (C 0.5263158) (G 0.26315793)))
                    (C ((A 0.25) (C 0.19999999) (G 0.54999995)))
                    (G ((A 0.22727273) (C 0.22727273) (G 0.5454545)))
                    (A ((A 0.5483871) (C 0.25806454) (G 0.1935484)))
                    (G ((A 0.18750001) (C 0.53125006) (G 0.28125))))))))


;; PPM* with Mixtures and Update Exclusion
;; ===========================================================================

(5am:def-suite ppm-mixtures-update-exclusion :in ppm)
(5am:in-suite ppm-mixtures-update-exclusion)

;; abracadabra (Cleary & Teahan, 1997; Bunton, 1996)
(5am:test abracadabra-ppmc*ui
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion t :order-bound nil)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.59999996) (B 0.09999999) (C 0.09999999) (D 0.09999999) (R 0.09999999)))
                    (R ((A 0.33333334) (B 0.33333334) (C 0.11111111) (D 0.11111111) (R 0.11111111)))
                    (A ((A 0.25) (B 0.25) (C 0.125) (D 0.125) (R 0.25)))
                    (C ((A 0.20000002) (B 0.53333336) (C 0.06666668) (D 0.06666668) (R 0.13333336)))
                    (A ((A 0.26666665) (B 0.19999997) (C 0.19999997) (D 0.13333331) (R 0.19999997)))
                    (D ((A 0.20833334) (B 0.2916667) (C 0.2916667) (D 0.083333336) (R 0.125)))
                    (A ((A 0.25) (B 0.1875) (C 0.1875) (D 0.1875) (R 0.1875)))
                    (B ((A 0.2093023) (B 0.21705426) (C 0.21705426) (D 0.21705426) (R 0.13953489)))
                    (R ((A 0.20000002) (B 0.13333334) (C 0.13333334) (D 0.13333334) (R 0.40000004)))
                    (A ((A 0.42857143) (B 0.14285715) (C 0.14285715) (D 0.14285715) (R 0.14285715)))
                    (C ((A 0.1356784) (B 0.19095479) (C 0.44221106) (D 0.14070353) (R 0.09045227))))))))

                 
;; PPM with mixtures and fixed order bound
;; ===========================================================================

(5am:def-suite ppm-mixtures-order-bound :in ppm)
(5am:in-suite ppm-mixtures-order-bound)

(5am:test abracadabra-ppmc2i
  (5am:is (and (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound 2)
                      (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound nil))
               (not (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound 1)
                           (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound nil))))))

(5am:test abracadabra-ppmc1i
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound 1)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.59999996) (B 0.09999999) (C 0.09999999) (D 0.09999999) (R 0.09999999)))
                    (R ((A 0.33333334) (B 0.33333334) (C 0.11111111) (D 0.11111111) (R 0.11111111)))
                    (A ((A 0.25) (B 0.25) (C 0.125) (D 0.125) (R 0.25)))
                    (C ((A 0.20000002) (B 0.53333336) (C 0.06666668) (D 0.06666668) (R 0.13333336)))
                    (A ((A 0.26666665) (B 0.19999997) (C 0.19999997) (D 0.13333331) (R 0.19999997)))
                    (D ((A 0.20833334) (B 0.2916667) (C 0.2916667) (D 0.083333336) (R 0.125)))
                    (A ((A 0.25) (B 0.1875) (C 0.1875) (D 0.1875) (R 0.1875)))
                    (B ((A 0.2093023) (B 0.21705426) (C 0.21705426) (D 0.21705426) (R 0.13953489)))
                    (R ((A 0.19148937) (B 0.14893615) (C 0.12765956) (D 0.12765956) (R 0.40425533)))
                    (A ((A 0.4347826) (B 0.1521739) (C 0.13043477) (D 0.13043477) (R 0.1521739)))
                    (C ((A 0.19230768) (B 0.2884615) (C 0.19230768) (D 0.19230768) (R 0.13461538))))))))
                 
(5am:test abracadabra-ppmc0i
  (5am:is (equal (test-ppm '(a b r a c a d a b r a c) :escape :c :mixtures t :update-exclusion nil :order-bound 0)
                 '((0 (A ((A 0.19999999) (B 0.19999999) (C 0.19999999) (D 0.19999999) (R 0.19999999)))
                    (B ((A 0.59999996) (B 0.09999999) (C 0.09999999) (D 0.09999999) (R 0.09999999)))
                    (R ((A 0.33333334) (B 0.33333334) (C 0.11111111) (D 0.11111111) (R 0.11111111)))
                    (A ((A 0.25) (B 0.25) (C 0.125) (D 0.125) (R 0.25)))
                    (C ((A 0.33333334) (B 0.22222221) (C 0.111111104) (D 0.111111104) (R 0.22222221)))
                    (A ((A 0.26666665) (B 0.19999997) (C 0.19999997) (D 0.13333331) (R 0.19999997)))
                    (D ((A 0.31250003) (B 0.18750003) (C 0.18750003) (D 0.125) (R 0.18750003)))
                    (A ((A 0.25) (B 0.1875) (C 0.1875) (D 0.1875) (R 0.1875)))
                    (B ((A 0.2727273) (B 0.18181819) (C 0.18181819) (D 0.18181819) (R 0.18181819)))
                    (R ((A 0.2647059) (B 0.20588236) (C 0.1764706) (D 0.1764706) (R 0.1764706)))
                    (A ((A 0.25714287) (B 0.19999999) (C 0.17142856) (D 0.17142856) (R 0.19999999)))
                    (C ((A 0.2777778) (B 0.19444445) (C 0.16666667) (D 0.16666667) (R 0.19444445))))))))
                 
;; letlettertele
(5am:test letlettertele-ppmc2i
  (5am:is (equal (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures t :update-exclusion nil :order-bound 2))))

(5am:test letlettertele-ppmc1i
  (5am:is (not (equal (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                      (test-ppm '(l e t l e t t e r t e l e) :escape :c :mixtures t :update-exclusion nil :order-bound 1)))))

;; assanissimassa
(5am:test assanissimassa-ppmc3i
  (5am:is (equal (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures t :update-exclusion nil :order-bound 3))))

(5am:test assanissimassa-ppmc2i
  (5am:is (not (equal (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                      (test-ppm '(a s s a n i s s i m a s s a) :escape :c :mixtures t :update-exclusion nil :order-bound 2)))))

;; missisippi
(5am:test mississippi-ppmc2i
  (5am:is (equal (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures t :update-exclusion nil :order-bound 2))))

(5am:test mississippi-ppmc1i
  (5am:is (not (equal (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                      (test-ppm '(m i s s i s s i p p i) :escape :c :mixtures t :update-exclusion nil :order-bound 1)))))

;; woolloomooloo
(5am:test woolloomooloo-ppmc2i
  (5am:is (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures t :update-exclusion nil :order-bound nil) 
                 (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures t :update-exclusion nil :order-bound 2))))

(5am:test woolloomooloo-ppmc1i
  (5am:is (not (equal (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures t :update-exclusion nil :order-bound nil) 
                      (test-ppm '(w o o l l o o m o o l o o) :escape :c :mixtures t :update-exclusion nil :order-bound 1)))))

;; agcgacgag
(5am:test agcgacgag-ppmc2i
  (5am:is (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                 (test-ppm '(a g c g a c g a g) :escape :c :mixtures t :update-exclusion nil :order-bound 2))))

(5am:test agcgacgag-ppmc1i
  (5am:is (not (equal (test-ppm '(a g c g a c g a g) :escape :c :mixtures t :update-exclusion nil :order-bound nil)
                      (test-ppm '(a g c g a c g a g) :escape :c :mixtures t :update-exclusion nil :order-bound 1)))))
